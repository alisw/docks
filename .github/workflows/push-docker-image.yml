# Build and push the selected docker image from a packer config.

name: Push Docker image

# Controls when the action will run: manual trigger with a parameter
on:
  workflow_dispatch:
    inputs:
      image-name:
        description: Docker image to build
        required: true
        default: slc8-builder

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    # We don't specify container: so we run directly on the virtual host
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v2

      - name: Install prerequisites
        run: |
          sudo -n env DEBIAN_FRONTEND=noninteractive apt install -y docker.io packer
          sudo -n systemctl unmask docker.service
          sudo -n systemctl start docker.service

      # Note: we're running under set -eo pipefail here
      - name: Build and push docker image
        run: |
          if ! cd "$GITHUB_WORKSPACE/${{ github.event.inputs.image-name }}"; then
            echo 'error: requested docker image not defined in this repo' >&2
            exit 1
          fi
          packer validate packer.json
          sudo -n docker login -u '${{ secrets.DOCKERHUB_USER }}' -p '${{ secrets.DOCKERHUB_PASSWORD }}'
          packer build packer.json
